{% extends "base.html" %}
{% load diggpaginator %}

{% block title %}Liste des machines{% endblock %}
{% block content_title %}Liste des machines{% endblock %}
{% block image %}<img src="/media/images/oxygen/search.png" />{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script type="text/javascript" src="{{ MEDIA_URL }}js/clariadmin.js"></script>
  <script type="text/javascript" charset="utf-8">
    dojo.require("dojox.grid.DataGrid");
    dojo.require("dijit.Menu");
    dojo.require('dijit.form.MultiSelect');
    dojo.require('dijit.form.CheckBox');
    dojo.require("dijit.Dialog");
    dojo.require("dojo.parser");
    dojo.require("dojox.validate");
    var dialog;
    dojo.addOnLoad(function(){
      dojo.forEach(dojo.query("#context_lines tr"), function(row, index)
      {
        create_menu(row.id, row.children[0].textContent);
        dojo.connect(row, "onclick", showHostPopup);
      });
      dialog = new dijit.Dialog({title: "Détails et édition de l'hote:",style: "width: 700px"});
      var global_search = dojo.byId("id_global_search");
      if (global_search)
        global_search.focus();
    });
    function showHostPopup(e){
      e = e || event;
      var target = e.srcElement || e.target;
      if(! (target.children.length || target.tagName == 'A')){
        dojo.xhrGet({
          url:"{% url clariadmin.views.modify -1 %}".replace('-1',target.parentNode.id.replace('comp_','')),
          load:function(data){
            dojo.forEach(dijit.findWidgets(dialog.containerNode), function(w) {w.destroyRecursive();});
            dialog.containerNode.innerHTML=data;
            dojo.parser.parse(dialog.containerNode);
            dojo.connect(dijit.byId("id_ajax-type"),"onchange",ajaxTypeChanged);
          }
        });
      dialog.show();
      }
    }

    function validateIfEnter(ievent) {
      if (ievent.keyCode == 13) {
        dojo.byId("search_form").submit();
      }
    }
    dojo.addOnLoad(
      function(){
        dojo.connect(dijit.byId("id_os"),"onKeyUp",validateIfEnter);
        dojo.connect(dijit.byId("id_type"),"onKeyUp",validateIfEnter);
        dojo.connect(dijit.byId("id_supplier"),"onKeyUp",validateIfEnter);
        dojo.connect(dijit.byId("id_site"),"onKeyUp",validateIfEnter);
    });

    function typeChanged(select_box){
      dojo.xhrGet({
          url: "{% url clariadmin.views.ajax_extra_fields_form -1 '/b' %}".replace('-1',select_box.item.value?select_box.item.value:-1),
          handleAs: "text",
          load: function(data){
            tab = dojo.byId("extra_fields");
            dojo.forEach(dijit.findWidgets(tab), function(w) {w.destroyRecursive();});
            tab.innerHTML = data;
            dojo.parser.parse(tab);
          }
      });
    }
    function create_menu(target_id, host_name) {
      pMenu = new dijit.Menu({
          targetNodeIds: [target_id,],
      });
      target_id = target_id.replace("comp_","");
      pMenu.addChild(new dijit.MenuItem({
            label: "Éditer "+host_name,
            iconClass: "dijitEditorIcon dijitEditorIconSave",
            onClick: function() {
              document.location.href = "{% url clariadmin.views.modify -1 %}".replace("-1", target_id);},
      }));
      pMenu.addChild(new dijit.MenuItem({
            label: "Suprimer "+host_name,
            iconClass: "dijitEditorIcon dijitEditorIconDelete",
            onClick: function() {
              confirmDialog("Supression de l hote", "Êtes vous sûr de vouloir supprimer cette machine de la base?",
                function(arg, url){
                  if(arg)
                    postwith({delete: "true"}, url);
                },
                "{% url clariadmin.views.modify -1 %}".replace("-1", target_id)
            )},
      }));
      pMenu.addChild(new dijit.MenuItem({
            label: "Éditer une copie de "+host_name,
            iconClass: "dijitEditorIcon dijitEditorIconCopy",
            onClick: function() {
              document.location.href = "{% url clariadmin.views.new -1 %}".replace("-1", target_id);
            },
      }));
      pMenu.startup();
    }
    function ajaxTypeChanged(evt){
      alert("ajaxTypeChanged");
        dojo.stopEvent(evt);
        dojo.byId("ajaxextra_fieldset").classList.remove("dijitHidden");
        dojo.xhrGet({
            url: "{% url clariadmin.views.ajax_extra_fields_form -1 %}".replace('-1',select_box.item.value?select_box.item.value:-1),
            load: function(data){
                  tab = dojo.byId("ajaxextra_fields");
                  dojo.forEach(dijit.findWidgets(tab), function(w) {w.destroyRecursive();});
                  tab.innerHTML = data;
                  dojo.parser.parse(tab);
                }
            });
    }
    function confirmation_callback(myBool, form_id){
        if(myBool)
            postwith({delete: "true"}, dojo.byId(form_id));
    }
  </script>

{% endblock %}
{% block content %}

  {% if form.security_can_view %}
    <form method="post" id="search_form">
      {% csrf_token %}
      <fieldset class="block form">
        <legend>Filtrage</legend>
        <table class="search">
          {{ form.as_column_table }}
        </table>
        <table id="extra_fields" class="search">{%if form_extra%}{{form_extra.as_table}}{%else%}<tr><td></td></tr>{%endif%}</table>
        <div class="left_buttons">
          <button type="reset" iconClass="dijitrtl dijitIconClear" dojoType="dijit.form.Button">Annuler</button>
          <button type="button" iconClass="dijitrtl dijitIconDelete" name="reset_button" onclick="postwith({filter_reset:'true'},'.')" dojoType="dijit.form.Button">Reset</button>
        </div>
        <div align='center'>
          <button type="submit"  dojoType="dijit.form.Button" iconClass="dijitrtl dijitIconSearch">Rechercher</button>
        </div>
      </fieldset>
    </form>
  {% else %}
    <p>Vous n'avez aucune permission de recherche.</p>
  {% endif %}

  {% if page.object_list %}
    {% if page.paginator.num_pages > 1 %}
      {% diggpaginator page %}
    {% endif %}
    <table class="resultat exportable" id="clariadmin_result_all">
      <thead>
        <tr>{%for column in columns %}
          <th><a href="?sort={% if sorting == column %}-{% endif %}{{ column }}">{% if sorting == column %}
              <img src="/media/images/oxygen/arrow-up.png" class="state_image" alt="down" />{% else %}{% if sorting == '-'|add:column %}
              <img src="/media/images/oxygen/arrow-down.png" class="state_image" alt="up" />{% endif %}{% endif %}
            {{ column }}</a></th>{% endfor %}
        </tr>
      </thead>
      <tbody id="context_lines">
          {% for row in page.object_list %}
          <tr id="comp_{{ row.id }}" class="{% cycle 'row1' 'row2'%}">
          {% if 'hostname' in columns %}<td><a href="{% url clariadmin.views.modify row.id %}">{{ row.hostname }}</a></td>{% endif %}
          {% if 'ip' in columns %}<td>{{ row.ip }}</td>{% endif %}
          {% if 'site' in columns %}<td>{{ row.site }}</td>{% endif %}
          {% if 'type' in columns %}<td style="color:{{row.type.color_fg}};background-color:{{row.type.color_bg}}">{{ row.type }}</td>{% endif %}
          {% if 'os' in columns %}<td>{{ row.os }}</td>{% endif %}
          {% if 'model' in columns %}<td>{{ row.supplier.name }}{% if row.model %} - {{ row.model }}{% endif %}</td>{% endif %}
          {% if 'status' in columns %}<td style="background-color:{{row.status_color}};">{{ row.status_text }}</td>{% endif %}
          {% if 'additionnal_fields' in columns %}<td>{% for f in row.additionnalfield_set.all %}{% if f.field.show %}<b>{{f.field.name}}:</b>{{f.value_readable}}, {% endif %}{% endfor %}</td>{% endif %}
        </tr>{% endfor %}
      </tbody>
    </table>
    {% if page.paginator.num_pages > 1 %}
      {% diggpaginator page %}
    {% endif %}
  {% endif %}
{% endblock %}
