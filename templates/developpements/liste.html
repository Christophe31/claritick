{% extends "developpements/base.html" %}

{% load sexyfication %}

{% block extrajs %}
    {{ block.super }}
    <script type="text/javascript">
        dojo.addOnLoad(function() {
            dojo.query("td.modifiable").forEach(function(ligne)
                {
                var itempk = dojo.attr(ligne, "itempk");
                var contextMenu = new dijit.Menu({
                    targetNodeIds: [ligne]
                    });
                contextMenu.addChild(new dijit.MenuItem({
                    label: "Modifier",
                    onClick: function(event) { form_request(itempk); },
                    }));
                if (dojo.attr(ligne, 'itempk'))
                    {
                    // C'est un dev, pas un groupedev
                    contextMenu.addChild(new dijit.MenuItem({
                        label: "Noter comme étant terminé",
                        onClick: function(event)
                            {
                            var defer = dojo.xhrGet({
                                url : "{% url developpements.views.done %}",
                                handleAs : "json",
                                content : {
                                    dev_pk : itempk,
                                    },
                                load: function (response)
                                    {
                                    if (response.error)
                                        {
                                        alert (response.error);
                                        }
                                    else
                                        {
                                        var limage = dojo.create('img');
                                        dojo.attr(limage, 'src', '{{ MEDIA_URL }}icones/bool-True.png');
                                        dojo.place(limage, "nom_" + response.dev_pk, "first");
                                        }
                                    }
                                });
                            }
                        }));
                    contextMenu.addChild(new dijit.MenuItem({
                        label: "Noter comme étant un bug",
                        onClick: function(event)
                            {
                            var defer = dojo.xhrGet({
                                url : "{% url developpements.views.bug %}",
                                handleAs : "json",
                                content : {
                                    dev_pk : itempk,
                                    },
                                load: function (response)
                                    {
                                    if (response.error)
                                        {
                                        alert (response.error);
                                        }
                                    else
                                        {
                                        var limage = dojo.create('img');
                                        dojo.attr(limage, 'src', '{{ MEDIA_URL }}icones/bug.png');
                                        dojo.place(limage, "nom_" + response.dev_pk, "first");
                                        }
                                    }
                                });
                            }
                        }));
                    contextMenu.addChild(new dijit.MenuItem({
                        label: "Pas de couleur",
                        onClick: function(event)
                            {
                            var defer = dojo.xhrGet({
                                url : "{% url developpements.views.change_color %}",
                                handleAs : "json",
                                content : {
                                    dev_pk : itempk,
                                    },
                                load: function (response)
                                    {
                                    if (response.error)
                                        {
                                        alert (response.error);
                                        }
                                    else if (response.couleur)
                                        {
                                        dojo.style("nom_" + response.dev_pk, "background-color", '#' + response.couleur);
                                        }
                                    else
                                        {
                                        dojo.style("nom_" + response.dev_pk, "background-color", 'inherit');
                                        }
                                    }
                                });
                            }
                        }));
                    {% for couleur in couleurs %}
                        contextMenu.addChild(new dijit.MenuItem({
                            label: "Couleur {{ couleur }}",
                            style: "background-color: #{{ couleur }};",
                            onClick: function(event)
                                {
                                var defer = dojo.xhrGet({
                                    url : "{% url developpements.views.change_color %}",
                                    handleAs : "json",
                                    content : {
                                        dev_pk : itempk,
                                        couleur : "{{ couleur }}"
                                        },
                                    load: function (response)
                                        {
                                        if (response.error)
                                            {
                                            alert (response.error);
                                            }
                                        else if (response.couleur)
                                            {
                                            dojo.style("nom_" + response.dev_pk, "background-color", '#' + response.couleur);
                                            }
                                        else
                                            {
                                            dojo.style("nom_" + response.dev_pk, "background-color", 'inherit');
                                            }
                                        }
                                    });
                                }
                            }));
                    {% endfor %}
                    }
                contextMenu.startup();
                });
            });
        function save_item_field(itempk, type, value_type, newvalue)
            {
            dojo.style('change_' + type + '_' + itempk, "background-color", "red");
            var defer = dojo.xhrGet({
                url : "{% url developpements.views.save_item_field %}",
                handleAs : "json",
                content : {
                    dev_pk : itempk,
                    field_type : type,
                    value_type : value_type,
                    newvalue : newvalue,
                    },
                load: function (response)
                    {
                    if (response.error)
                        {
                        alert (response.error);
                        }
                    else
                        {
                        dojo.style("change_" + type + "_" + itempk, "backgroundColor", "green");
                        }
                    },
                error: function(error)
                    {
                    alert (error);
                    }
                });
            }
        function change_version_requise(itempk)
            {
            var dialog = new dijit.Dialog({
                title : 'Choix de la version',
                width: '350',
                });
            console.debug(dialog);
            dialog.attr('content', '<ul>{% for vexist in versions_existantes %}<li><a href="#" onClick="choose_new_version(' + itempk + ', {{ vexist.id }}, \'' + dialog.id + '\');">{{ vexist.majeur }}.{{ vexist.mineur }}.{{ vexist.revision }}</a></li>{% endfor %}</ul>');
            dialog.show();
            }
        function choose_new_version(itempk, versionpk, dialog_id)
            {
            console.debug(dialog_id);
            dojo.style('change_version_requise_' + itempk, "background-color", "red");
            var defer = dojo.xhrGet({
                url : "{% url developpements.views.save_item_field %}",
                handleAs : "json",
                content : {
                    dev_pk : itempk,
                    field_type : 'version_requise',
                    value_type : 'integer',
                    newvalue : versionpk,
                    },
                load: function (response)
                    {
                    if (response.error)
                        {
                        alert (response.error);
                        }
                    else
                        {
                        dojo.style("change_version_requise_" + itempk, "backgroundColor", "green");
                        dojo.attr('change_version_requise_' + itempk, 'innerHTML', response.innerHTML);
                        console.debug(dialog_id);
                        dijit.byId(dialog_id).hide();
                        }
                    },
                error: function(error)
                    {
                    alert (error);
                    }
                });
            }
    </script>
{% endblock %}

{% block content %}
    {{ block.super }}
    <table id="table_dev">
        <thead>
            <tr style="background-color: #C0C0C0;">
                <th>&nbsp;</th>
                {# poids total <th>&nbsp;</th> #}
                <th title="Cliens demandeurs">Clients</th>
                <th title="Poids de l'item">P</th>
                <th>Groupe</th>
                <th title="Poids du groupe">PG</th>
                <th title="Poids manuel">PM</th>
                <th>Libellé</th>
                <th title="Temps prévu (heures)">Temps</th>
                <th title="Version requise">VR</th>
                <th title="Date engagement">Eng</th>
                <th title="Date de sortie possible">Sortie</th>
                <th>&nbsp;</th>
            </tr>
        </thead>
        <tbody>
            {% for item in developpements %}
                <tr>
                    <td class="align-center" style="background-color: #C0C0C0;">{{ forloop.counter }}</td>
                    {# <td class="align-center" style="background-color: #C0C0C0;">{{ item.poids_total }}</td> #}
                    <td class="align-right" title="{{ item.clients|join:" " }}">{{ item.clients|length }}</td>
                    <td class="align-right">
                        <span id="change_poids_{{ item.pk }}" dojoType="dijit.InlineEditBox" onChange="save_item_field({{ item.pk }}, 'poids', 'integer', this.value);" autoSave="true">{{ item.poids }}</span>
                    </td>
                    <td class="{% if perms.developpements.change_groupedev %}modifiable{% endif %}" url="{% url admin:developpements_groupedev_change item.groupe.pk %}" title="{{ item.groupe.description }}">
                        {{ item.groupe }}
                    </td>
                    <td class="align-right" title="{{ item.poids_total }}">
                        <span id="change_poids_groupe_{{ item.pk }}" dojoType="dijit.InlineEditBox" onChange="save_item_field({{ item.pk }}, 'poids_groupe', 'integer', this.value);" autoSave="true">{{ item.groupe.poids }}</span>
                    </td>
                    <td class="align-right" title="{{ item.poids_total }}">
                        <span id="change_poids_manuel_{{ item.pk }}" dojoType="dijit.InlineEditBox" onChange="save_item_field({{ item.pk }}, 'poids_manuel', 'float', this.value);" autoSave="true"> {{ item.poids_manuel }}</span>
                    </td>
                    <td class="{% if perms.developpements.change_developpement %}modifiable{% endif %}{% if item.done %} done{% endif %}" url="{% url admin:developpements_developpement_change item.pk %}"
                        title="{{ item.description }}"
                        itempk="{{ item.pk }}"
                        id="nom_{{ item.pk }}"
                        {% if item.couleur %}style="background-color: #{{ item.couleur }};"{% endif %}>
                        {% if item.done %}{{ item.done|boolicon }}{% endif %}
                        {% if item.bug %}<img src="{{ MEDIA_URL }}icones/bug.png"/>&nbsp;{% endif %}
                        <span id="change_nom_{{ item.pk }}" dojoType="dijit.InlineEditBox" onChange="save_item_field({{item.pk}}, 'nom', 'string', this.value);" autoSave="true">{{ item.nom }}</span>
                        {# <div dojoType="dijit.Dialog" title="{{ item.nom }}" id="dialog_{{ item.pk }}">{{ item.description|urlize }}</div> #}
                    </td>
                    <td class="align-right">
                        <span id="change_temps_prevu_{{ item.pk }}" dojoType="dijit.InlineEditBox" onChange="save_item_field({{ item.pk }}, 'temps_prevu', 'integer', this.value);" autoSave="true">{{ item.temps_prevu|default_if_none:"&empty;" }}</span>
                    </td>
                    <td>
                        <a id="change_version_requise_{{ item.pk }}" href="javascript:void();" onClick="change_version_requise({{ item.pk }}, this);">{{ item.version_requise|default_if_none:"&nbsp;" }}</a>
                    </td>
                    <td class="align-center">{{ item.engagement|date:"d/m/Y" }}</td>
                    <td class="align-center" title="{{ item.date_sortie|date:"d/m/Y" }}">
                        {% if item.deja_dispo %}
                            {{ item.deja_dispo }}
                        {% else %}{% if item.done %}
                            Proch. version
                        {% else %}
                            Sem. {{ item.date_sortie|date:'W' }}
                        {% endif %}{% endif %}
                    </td>
                    <td class="align-center">
                        {% if item.alerte %}
                            <img src="{{ MEDIA_URL }}icones/incendie.png" title="{{ item.alerte }}" alt="alerte"/>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}
