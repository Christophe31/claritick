{% extends "base.html" %}

{% block extrajs %}
<script type="text/javascript">
    var MENU_CAN_HIDE = false;
    dojo.addOnLoad(function() { 
        dojo.style("gauche", "display", "block"); 
        dojo.style("menuPrincipal", "paddingLeft", "210px"); 
        dojo.style("contenu", "marginLeft", "210px"); 
    });
</script>
{% endblock %}

{% block content %}
{% if not user.is_authenticated %}
<p style="margin-bottom: 0;">Merci de vous <a href="/accounts/login/">IDENTIFIER</a></p>
<h1 style="text-align: left; color: black; padding: 0; margin: 0;">Rechercher sur Google:</h1>
<!-- GOogle search -->
<div id="cse" style="text-align: left; padding: 0 !important;">Chargement...</div>
<script src="https://www.google.com/jsapi" type="text/javascript"></script>
<script type="text/javascript">
  google.load('search', '1', {language : 'fr'});
  google.setOnLoadCallback(function() {
    var customSearchControl = new google.search.CustomSearchControl('016334670055041449914:jgrecjhkx1o');
    customSearchControl.setResultSetSize(google.search.Search.LARGE_RESULTSET);
    customSearchControl.draw('cse');
  }, true);
</script>
<link rel="stylesheet" href="https://www.google.com/cse/style/look/default.css" type="text/css" /> 
<!-- End GOogle search -->

{% else %}
<div id="index_content">
    {% if ticket_alarms %}
    <div class="container">
        <h2>Alarmes</h2>
        <ul>
          {% for ticket in ticket_alarms %}
            <li><a href="{% url ticket_modify ticket.pk %}">[{{ ticket.id }}] {{ ticket.title|truncatewords:8 }}</a></li>
          {% endfor %}
        </ul>
    </div>
    {% endif %}
    {% if ticket_dashboard_critical %}
    <div id="list_critical_tickets" class="container" style="width: 500px;" >
        <h2>Tickets critiques</h2>
        <ul>
          {% for ticket in ticket_dashboard_critical %}
            <li><a href="{% url ticket_modify ticket.pk %}">[{{ ticket.id }}] {{ ticket.title|truncatewords:8 }}</a></li>
          {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    {% if ticket_dashboard_text_statistics %}
    <div id="list_stats" class="container">
        <h2>Statistiques</h2>
        <ul>
          {% for entry in ticket_dashboard_text_statistics %}
            <li>{{ entry }}</li>
          {% endfor %}
        </ul>
    </div>
    {% endif %}
    <div id="stats_graph" class="container" style="width: 500px; height: auto;">
        <h2>Graphiques</h2>
        <p id="stats_graph_loading">Chargement...</p>
        <script type="text/javascript">
        
        /* Helper to generate dojox chart */
        function generate_graph(name, chart_data)
        {
            var chart1 = new dojox.charting.Chart2D("chart_"+name);
            chart1.setTheme(dojox.charting.themes.Harmony);
            chart1.addPlot("default", {
                type: "Lines", 
                shadows: {dx: 2, dy: 2, dw: 2},
                tension: 4,
                markers: true
            });
            chart1.addAxis("x", {labels: chart_data.x_labels});
            chart1.addAxis("y", {
                vertical: true, majorTicks: true, 
                majorLabels: true, minorTicks: false, 
                minorLabels: false, microTicks: false
            });
            chart1.addSeries("line", chart_data.y_values, chart_data.series_properties);
            chart1.render();
            var legend = new dojox.charting.widget.Legend({chart: chart1, horizontal: true}, "chart_legend_"+name);
        } /* Chart helper */
        
        /* Helper to generate dojox chart */
        function generate_graph_average_delay(name, series, x_labels)
        {
            var chart2 = new dojox.charting.Chart2D("chart_"+name);
            chart2.setTheme(dojox.charting.themes.Shrooms);
            chart2.addPlot("default", {
                type: "Lines", 
                shadows: {dx: 2, dy: 2, dw: 2},
                tension: 4,
                markers: true
            });
            chart2.addAxis("x", {labels: x_labels});
            chart2.addAxis("y", {
                vertical: true, majorTicks: true, 
                majorLabels: true, minorTicks: false, 
                minorLabels: false, microTicks: false
            });
            
            dojo.forEach(series, function(serie, idx) {
                chart2.addSeries("line"+idx, serie.values, serie.properties);
            });
            
            chart2.render();
            var legend2 = new dojox.charting.widget.Legend({chart: chart2, horizontal: true}, "chart_legend_"+name);
        } /* Chart helper */
    
        setTimeout(function(){
            dojo.destroy("stats_graph_loading");
            dojo.require("dojox.charting.Chart2D");
            dojo.require("dojox.charting.themes.Harmony");
            dojo.require("dojox.charting.themes.Shrooms");
            dojo.require("dojox.charting.widget.Legend");
            SimpleAjax('{% url ajax_graph_permonth %}', '', function(ajax_response)
            {
                if (! ajax_response.charts) { return; }
                dojo.forEach(ajax_response.charts, function(chart_data, index) {
                    var name="permonth_"+index;
                    dojo.create('div', {'id': 'chart_legend_'+name, 'style': {'padding': 0, 'margin': 0}}, "stats_graph");
                    dojo.create('div', {'id': 'chart_'+name, 'class': 'chart'}, "stats_graph");
                    generate_graph(name, chart_data);
                });
            });
            SimpleAjax('{% url ajax_graph_average_close_time %}', '', function(ajax_response)
            {
                if (! ajax_response.series) { return; }
                var name = "average_delay";
                dojo.create('div', {'id': 'chart_legend_'+name, 'style': {'padding': 0, 'margin': 0}}, "stats_graph");
                dojo.create('div', {'id': 'chart_'+name, 'class': 'chart'}, "stats_graph");
                generate_graph_average_delay(name, ajax_response.series, ajax_response.x_labels);
            });
        }, 5000);
        </script>
    </div>
</div>
{% endif %}

{% endblock %}
