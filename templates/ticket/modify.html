<!-- <?xml version='1.0' encoding='utf-8'?> -->
{% extends "base.html" %}

{% block title %}Ticket numéro {{ ticket.id }}{% endblock %}
{% block content_title %}Ticket numéro {{ ticket.id }}{% endblock %}
{% block image %}<img src="/media/images/oxygen/folder-open.png" />{% endblock %}

{% block content %}

{{ form.non_field_errors }}

<form enctype="multipart/form-data" action="{% url ticket_modify ticket.id %}" method="POST" id="form_ticket_modify">
{% csrf_token %}
{% block content_ticket %}
<fieldset class="inline form">
  <legend>Général</legend>
  <div><label for="id_category">Categorie</label> {{ form.category }}</div>
  <div><label for="id_project">Projet</label> {{ form.project }}</div>
  <div><label for="id_priority">Priorité</label> {{ form.priority }}</div>
  <div><label for="id_state">État</label> {{ form.state }}</div>
</fieldset>

<fieldset class="block form">
  <legend>Contact</legend>
  <table>
    <tr>
        <td class="large"><label for="id_client">Client</label></td><td>{{ form.client }}</td>
        <td class="large right"><label for="id_assigned_to">Assigné à</label></td><td>{{ form.assigned_to }}</td>
    </tr>
    <tr>
        <td class="large"><label for="id_contact">Contact</label></td><td>{{ form.contact }}</td>
        <td class="large right"><label for="id_opened_by">Ouvert par</label></td><td>{{ ticket.opened_by }} le {{ ticket.date_open|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large"><label for="id_phone">Téléphone</label></td><td>{{ form.telephone }}
            <div dojoType="dijit.form.Button" onClick="loadTelephone();" id="telephoneContainer">Préselection</div>
            <!-- Dojo dialog telephone preselection -->
            <script type="text/javascript">
            function loadTelephone() {
                var client = dijit.byId("id_client");
                var client_id = client.value;

                SimpleAjax('{% url ajax_load_telephone %}', 'client_id='+client_id, function(ajax_response)
                {
                    if (! ajax_response.telephones) { return; }
                    var menu = dijit.byId('telephone_menu');
                    if (menu) {
                        menu.destroyRecursive();
                    } else {
                        menu = new dijit.Menu({id: 'telephone_menu'});
                        
                        var telephone;
                        dojo.forEach(ajax_response.telephones, function(telephone) {
                            var menuItem = new dijit.MenuItem({
                                    label: telephone[1],
                                    onClick: function() {
                                        dojo.byId('id_telephone').value = telephone[0];
                                        menu.destroyRecursive();
                                    }
                                });
                            menu.addChild(menuItem);
                        });
                        dojo.byId("telephoneContainer").appendChild(menu.domNode);
                        menu.focus();
                    }
                });
            }
            </script>
            <!-- / Telephone preselection -->
        </td>
        <td class="large right"><label for="id_last_modification">Dernière modif.</label></td><td>le {{ ticket.last_modification|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">&nbsp;</td><td></td>
        <td class="large right">
            {% if ticket.validated_by %}
                <strong>Validé par</strong></td><td>{{ ticket.validated_by }}
            {% else %}
                {% if perms.ticket.can_validate_ticket %}
                    <td colspan="2"><button type="submit" dojoType="dijit.form.Button" name="_validate-ticket" value="Valider ce ticket">Valider ce ticket</button></td>
                {% else %}
                    <strong>Validation:</strong></td><td><strong>En attente</strong>
                {% endif %}
            {% endif %}
        </td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
  <legend>Contenu</legend>
  <table>
    <tr>
        <th class="large">{{ form.title.label_tag }}</th>
        <td class="large right">{{ form.title }}</td>
    </tr>
    <tr>
        <th></th>
        <td class="right">{{ form.text }}</td>
    </tr>
    <tr>
        <th>{{ form.keywords.label_tag }}</th>
        <td class="right">{{ form.keywords }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form" style="padding: 0;">
  <legend>Réponses</legend>
{% load comments %}
{% get_comment_list for ticket as comment_list %}

{% if comment_list %}
<table class="comment_table">
  <thead>
    <tr>
        <th width="50%">Interne</td>
        <th width="50%">Diffusé au client</td>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td>
            {% for comment in comment_list %}{% if comment.internal %}<div class="comment">
                <h3><b>{{ comment.user.first_name }} {{ comment.user.last_name }}</b> ({{ comment.user_name }})&nbsp;<i>Le {{ comment.submit_date|date:'d/m/Y à H\hi' }}</i></h3>
                <pre class="{% cycle 'row1' 'row2' %}">{{ comment.comment|wordwrap:80 }}</pre>
            </div>{% endif %}{% endfor %}
        </td>
        <td>
            {% for comment in comment_list %}{% if not comment.internal %}<div class="comment">
                <h3><b>{{ comment.user.first_name }} {{ comment.user.last_name }}</b> ({{ comment.user_name }})&nbsp;<i>Le {{ comment.submit_date|date:'d/m/Y à H\hi' }}</i></h3>
                <pre class="{% cycle 'row1' 'row2' %}">{{ comment.comment|wordwrap:80 }}</pre>
            </div>{% endif %}{% endfor %}
        </td>
      </tr>
    </tbody>
</table>
{% else %}
<p>Aucune réponse.</p>
{% endif %}

{% block comment_form %}
    {{ form_comment.errors }}
    <div style="display: none">
    {{ form_comment.timestamp }}
    {{ form_comment.object_pk }}
    {{ form_comment.security_hash }}
    {{ form_comment.content_type }}
    <input type="hidden" name="email" value="{% if request.user.email %}{{ request.user.email }}{% else %}noreply@invalid.com{% endif %}" />
    <input type="hidden" name="name" value="{% if request.user.username %}{{ request.user.username }}{% else %}anonyme{% endif %}" />
    </div>
    <table>
        <tr>
            <td>{{ form_comment.non_field_errors }}</td>
        </tr>
        <tr>
            <td>Nouvelle réponse: {{ form_comment.comment }}</td>
        </tr>
        <tr>
            <td><button dojoType="dijit.form.Button" type="submit" name="submit-comment" value="1">Ajouter le commentaire</button></td>
        </tr>
    </table>
    <div dojoType="dijit.Tooltip" connectId="id_comment" position="after">
        <div id="commentaire_diffuse" style="display: none;">
            <img src="/media/images/oxygen/comment_public.png" alt="commentaire_public" />
            <p>Attention, la réponse sera transmise au client final.</p>
        </div>
        <div id="commentaire_interne">
            <img src="/media/images/oxygen/comment_internal.png" alt="commentaire_interne" />
            <p>La réponse sera concervée en interne.</p>
        </div>
    </div>
    <p>{{ form_comment.internal }} Commentaire <b>interne</b> (Si cette case est cochée, cette réponse ne sera pas transmise au client final)</p>
    <script type="text/javascript">
    dojo.addOnLoad(function() {
        var checkbox_internal = dojo.byId("id_internal");
        dojo.connect(checkbox_internal, "onchange", function() {
            if (checkbox_internal.checked) {
                dojo.style("commentaire_diffuse", "display", "none");
                dojo.style("commentaire_interne", "display", "block");
            } else {
                dojo.style("commentaire_diffuse", "display", "block");
                dojo.style("commentaire_interne", "display", "none");            
            }
        });
    });
    </script>
{% endblock %}
</fieldset>


<fieldset class="block form">
  <legend>Planification</legend>
  <table>
    <tr>
        <th class="large">{{ form.calendar_start_time.label_tag }}</th>
        <td class="right">{{ form.calendar_start_time }}</td>
    </tr>
    <tr>
        <th class="large">{{ form.calendar_end_time.label_tag }}</th>
        <td class="right">{{ form.calendar_end_time }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
    <legend>Fichiers joint</legend>
    <table>
        {% for file in ticket.ticketfile_set.all %}
        <tr>
            <td><a href="{% url ticket_get_file file.pk %}">{{ file.filename }}</a></td>
        </tr>
        {% endfor %}
        <tr>
            <td>{{ form.file }}</td>
        </tr>
    </table>
</fieldset>
<hr />

<div id="save_buttons">
  <button dojoType="dijit.form.Button" type="submit" name="savebutton" value="save" iconClass="dijitEditorIcon dijitEditorIconSave">Enregistrer</button>
  <button dojoType="dijit.form.Button" type="submit" name="savebutton" value="new" iconClass="dijitEditorIcon dijitEditorIconSave">Enregistrer et ajouter un nouveau</button>
  <button dojoType="dijit.form.Button" type="submit" name="savebutton" value="return" iconClass="dijitEditorIcon dijitEditorIconSave"  class="default">Enregistrer et retourner à la liste</button>
</div>
{% endblock %}

</form>
{% endblock %}
