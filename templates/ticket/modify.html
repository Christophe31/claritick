<!-- <?xml version='1.0' encoding='utf-8'?> -->
{% extends "base.html" %}

{% block title %}Ticket numéro {{ ticket.id }}{% endblock %}
{% block content_title %}Ticket numéro {{ ticket.id }}{% endblock %}
{% block image %}<img src="/media/images/oxygen/folder-open.png" />{% endblock %}

{% block content %}

{{ form.non_field_errors }}

<div id="parent">
<form enctype="multipart/form-data" action="{% url ticket_modify ticket.id %}" method="post" id="form_ticket_modify">
{% csrf_token %}
{% block content_ticket %}
<fieldset class="inline form">
  <legend>Général</legend>
  <div><label for="id_category">Catégorie</label> {{ form.category }}</div>
  <div><label for="id_project">Projet</label> {{ form.project }}</div>
  <div><label for="id_priority">Priorité</label> {{ form.priority }}</div>
  <div><label for="id_state">État</label> {{ form.state }}</div>
</fieldset>

<fieldset class="block form">
  <legend>Contact</legend>
  <table>
    <tr>
        <td class="large"><label for="id_client">Client</label></td><td>{{ form.client }}</td>
        <td class="large right"><label for="id_assigned_to">Assigné à</label></td><td>{{ form.assigned_to }}</td>
    </tr>
    <tr>
        <td class="large"><label for="id_contact">Contact</label></td><td>{{ form.contact }}</td>
        <td class="large right"><label for="id_opened_by">Ouvert par</label></td><td>{{ ticket.opened_by }} le {{ ticket.date_open|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large"><label for="id_telephone">Téléphone</label></td><td>{{ form.telephone }}
            <div dojoType="dijit.form.Button" onClick="loadTelephone();" id="telephoneContainer">Présélection</div>
            <!-- Dojo dialog telephone preselection -->
            <script type="text/javascript">
            function loadTelephone() {
                var client = dijit.byId("id_client");
                var client_id = client.value;

                SimpleAjax('{% url ajax_load_telephone %}', 'client_id='+client_id, function(ajax_response)
                {
                    if (! ajax_response.telephones) { return; }
                    var menu = dijit.byId('telephone_menu');
                    if (menu) {
                        menu.destroyRecursive();
                    } else {
                        menu = new dijit.Menu({id: 'telephone_menu'});
                        
                        var telephone;
                        dojo.forEach(ajax_response.telephones, function(telephone) {
                            var menuItem = new dijit.MenuItem({
                                    label: telephone[1],
                                    onClick: function() {
                                        dojo.byId('id_telephone').value = telephone[0];
                                        menu.destroyRecursive();
                                    }
                                });
                            menu.addChild(menuItem);
                        });
                        dojo.byId("telephoneContainer").appendChild(menu.domNode);
                        menu.focus();
                    }
                });
            }
            </script>
            <!-- / Telephone preselection -->
        </td>
        <td class="large right"><label for="id_last_modification">Dernière modif.</label></td><td>le {{ ticket.last_modification|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">&nbsp;</td><td></td>
        <td class="large right">
            {% if ticket.validated_by %}
                <strong>Validé par</strong></td><td>{{ ticket.validated_by }}
            {% else %}
                {% if perms.ticket.can_validate_ticket %}
                    <td colspan="2"><button type="submit" dojoType="dijit.form.Button" name="_validate-ticket" value="Valider ce ticket">Valider ce ticket</button></td>
                {% else %}
                    <strong>Validation:</strong></td><td><strong>En attente</strong>
                {% endif %}
            {% endif %}
        </td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
  <legend>Contenu</legend>
  <table>
    <tr>
        <th class="large">{{ form.title.label_tag }}</th>
        <td class="large right">{{ form.title }}</td>
    </tr>
    <tr>
        <th></th>
        <td class="right">{{ form.text }}</td>
    </tr>
    <tr>
        <th>{{ form.keywords.label_tag }}</th>
        <td class="right">{{ form.keywords }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form" style="padding: 0;">
  <legend>Réponses</legend>
{% load comments %}
{% get_comment_list for ticket as comment_list %}

{% if comment_list %}
<table class="comment_table">
  <thead>
    <tr>
        <th style="width:48%">Interne</th>
        <th style="width:48%">Diffusé au client</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td>
            {% for comment in comment_list %}{% if comment.internal %}<div class="comment">
                <h3><b>{{ comment.user.first_name }} {{ comment.user.last_name }}</b> ({{ comment.user_name }})&nbsp;<i>Le {{ comment.submit_date|date:'d/m/Y à H\hi' }}</i></h3>
                <pre class="{% cycle 'row1' 'row2' %}">{{ comment.comment|wordwrap:80 }}</pre>
            </div>{% endif %}{% endfor %}
        </td>
        <td>
            {% for comment in comment_list %}{% if not comment.internal %}<div class="comment">
                <h3><b>{{ comment.user.first_name }} {{ comment.user.last_name }}</b> ({{ comment.user_name }})&nbsp;<i>Le {{ comment.submit_date|date:'d/m/Y à H\hi' }}</i></h3>
                <pre class="{% cycle 'row1' 'row2' %}">{{ comment.comment|wordwrap:80 }}</pre>
            </div>{% endif %}{% endfor %}
        </td>
      </tr>
    </tbody>
</table>
{% else %}
<p>Aucune réponse.</p>
{% endif %}

{% block comment_form %}
    {{ comment_form.errors }}
    <div style="display: none">
    {{ comment_form.timestamp }}
    {{ comment_form.object_pk }}
    {{ comment_form.security_hash }}
    {{ comment_form.content_type }}
    <input type="hidden" name="email" value="{% if request.user.email %}{{ request.user.email }}{% else %}noreply@invalid.com{% endif %}" />
    <input type="hidden" name="name" value="{% if request.user.username %}{{ request.user.username }}{% else %}anonyme{% endif %}" />
    </div>
    <table>
        <tr>
            <td>{{ comment_form.non_field_errors }}</td>
        </tr>
        <tr>
            <td>Nouvelle réponse: <textarea id="parent_comment" rows="10" cols="40" name="comment"></textarea></td>
        </tr>
    </table>
    <div dojoType="dijit.Tooltip" connectId="parent_comment" position="after" id="dijit_parent_comment">
        <div style="display: none;">
            <img src="/media/images/oxygen/comment_public.png" alt="commentaire_public" />
            <p>Attention, la réponse sera transmise au client final</p>
        </div>
        <div>
            <img src="/media/images/oxygen/comment_internal.png" alt="commentaire_interne" />
            <p>La réponse sera conservée en interne</p>
        </div>
    </div>
    <p><input type="checkbox" checked="checked" name="internal" onChange="toggleComment(this, 'dijit_parent_comment');" /> Commentaire <b>interne</b> (Si cette case est cochée, cette réponse ne sera pas transmise au client final)</p>
{% endblock %}
</fieldset>

<script type="text/javascript">
    function toggleComment(id, did) {
        if (id.checked) {
            dojo.byId(did).children[0].style.display = 'none';
            dojo.byId(did).children[1].style.display = 'block';
        }
        else {
            dojo.byId(did).children[0].style.display = 'block';
            dojo.byId(did).children[1].style.display = 'none';
        }
    }
</script>

<fieldset class="block form">
  <legend>Planification</legend>
  <table>
    <tr>
        <th class="large">{{ form.calendar_start_time.label_tag }}</th>
        <td class="right">{{ form.calendar_start_time }}</td>
    </tr>
    <tr>
        <th class="large">{{ form.calendar_end_time.label_tag }}</th>
        <td class="right">{{ form.calendar_end_time }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
    <legend>Fichiers joint</legend>
    <table>
        {% for file in ticket.ticketfile_set.all %}
        <tr>
            <td><a href="{% url ticket_get_file file.pk %}">{{ file.filename }}</a></td>
        </tr>
        {% endfor %}
        <tr>
            <td>{{ form.file }}</td>
        </tr>
    </table>
</fieldset>
<hr />

{% if perms.ticket.change_child %}
<div><input type="hidden" id="savebutton" name="savebutton" value="save" /></div>
{% else %}
<div id="save_buttons">
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="save">Enregistrer</button>
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="new">Enregistrer et ajouter un nouveau</button>
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" class="default" type="submit" name="savebutton" value="return">Enregistrer et retourner à la liste</button>
</div>
{% endif %}

</form>
</div><!-- parent -->
{% endblock %}

<script type="text/javascript">
{% if perms.ticket.change_child %}
    var last_focused = dojo.byId("parent");
    var child_count = 0;
    var fl = null; /* focus list */

    dojo.addOnLoad(function () {
            fl = dojo.query("div[id^=child]");
            fl.style("opacity", "0.5");
            fl.push(dojo.byId("parent"));
            fl.onclick(get_focus);
            if (dojo.doc.location.hash != '') {
                dojo.query(dojo.doc.location.hash).style("opacity", "1");
                dojo.style("parent", "opacity", "0.5");
            }
            });

    function get_focus (ev) {
        fl.style("opacity", "0.5");
        dojo.style(this, "opacity", "1");
        last_focused = this;
    }

    function addTofl(id) {
        fl.style("opacity", "0.5");
        fl.push(dojo.byId(id));
        dojo.connect(dojo.byId(id), 'onclick', get_focus);
        dojo.style(id, "opacity", "1");
        dojo.doc.location = '#'+id;
    }

    function loadChild () {
        dojo.xhrGet({url: '{% url ajax_load_child ticket.id %}',
                headers: {"X-Claritick-Tid": "child0"+child_count},
                load: function (d) {
                dojo.place(d, 'div_childs', 'last');
                last_focused = dojo.byId("child0"+child_count);
                addTofl(last_focused.id);
                child_count++;
                }});
    }

    function submitTicket() {
        var f = last_focused.children[0];
        var ticket_id;

        if (last_focused == dojo.byId("parent"))
            f.submit();
        else {
            dojo.xhrPost({form: f,
                    headers: {"X-Claritick-Tid": last_focused.id},
                    load: function (d, r) {
                    var dijit_id;
                    if (!(ticket_id = r.xhr.getResponseHeader("X-Claritick-Tid")))
                        ticket_id = last_focused.id;
                    dojo.place(d, last_focused, 'replace');
                    last_focused = dojo.byId(ticket_id);
                    addTofl(last_focused.id);
                    if ((dijit_id = dijit.byId('dijit_'+last_focused.id+'_comment')))
                        dijit_id.destroyRecursive();
                    dojo.parser.parse(last_focused);
                    }});
        }
    }
    function submitAll(saveaction) {
        var ticket_id;
        var error = 0;
        dojo.query("div[id^=child]").query("form").forEach(function (f) {
                dojo.xhrPost({form: f,
                    headers: {"X-Claritick-Tid": f.parentNode.id },
                    sync: true,
                    load: function (d, r) {
                    if (r.xhr.status != 201) {
                        error = 1;
                        if (!(ticket_id = r.xhr.getResponseHeader("X-Claritick-Tid")))
                            ticket_id = f.parentNode.id;
                        dojo.place(d, f.parentNode.id, 'replace');
                        last_focused = dojo.byId(ticket_id);
                        addTofl(last_focused.id);
                        }},
                    });});
        if (error == 0) {
            dojo.byId("savebutton").value = saveaction;
            dojo.byId("parent").children[0].submit();
        }
        else
            dojo.doc.location.hash = '#'+ticket_id;
    }
{% endif %}
    function togglePlusMinus(id) {
        if (dojo.style("content_child"+id, "display") == "block") {
            dojo.style("content_child"+id, "display", "none");
            dojo.byId("form_summary_child"+id).src = "/media/images/plus.png";
        }
        else {
            dojo.style("content_child"+id, "display", "block");
            dojo.byId("form_summary_child"+id).src = "/media/images/minus.png";
        }
    }
</script>

<div id="div_childs" class="childs">
{% for child,cf,cfc in child_form %}
{% include "ticket/child.html" %}
{% endfor %}
</div>

{% if perms.ticket.change_child %}
<div id="save_buttons">
  <button dojoType="dijit.form.Button" onClick="submitTicket();" iconClass="dijitEditorIcon dijitEditorIconSave">Enregistrer</button>
  <button dojoType="dijit.form.Button" onClick="submitAll('save');" iconClass="dijitEditorIcon dijitEditorIconSave">Enregistrer tout</button>
  <button dojoType="dijit.form.Button" onClick="submitAll('new');" iconClass="dijitEditorIcon dijitEditorIconSave">Enregistrer tout et ajouter un nouveau</button>
  <button dojoType="dijit.form.Button" onClick="submitAll('return');" iconClass="dijitEditorIcon dijitEditorIconSave" class="default">Enregistrer tout et retourner à la liste</button>
{% if perms.ticket.add_child %}<div dojoType="dijit.form.Button" onClick="loadChild();" id="button_add_child">Ajouter un fils</div>{% endif %}
</div>
{% endif %}


{% endblock %}
