<!-- <?xml version='1.0' encoding='utf-8'?> -->
{% extends "base.html" %}

{% block title %}Ticket numéro {{ form.instance.id }}{% endblock %}
{% block content_title %}Ticket numéro {{ form.instance.id }}{% endblock %}
{% block image %}<img src="/media/images/oxygen/folder-open.png" />{% endblock %}

{% block content %}
{{ form.non_field_errors }}
<form enctype="multipart/form-data" action="{% url ticket_modify form.instance.id %}" method="post">
<div id="parent">
{% csrf_token %}
{% block content_ticket %}
<fieldset id="fieldset_general" class="inline form">
  <legend>Général</legend>
  <div>{{ form.category.label_tag }} {{ form.category }}</div>
  <div>{{ form.project.label_tag }} {{ form.project }}</div>
  <div>{{ form.priority.label_tag }} {{ form.priority }}</div>
  <div>{{ form.state.label_tag }} {{ form.state }}</div>
</fieldset>

<script type="text/javascript">
    dojo.addOnLoad(function () {
            var was_fixed = false;
            dojo.connect(dojo.global, 'scroll', function () {
                if (dojo.global.pageYOffset > 117) {
                    dojo.query('#fieldset_general').attr('class', 'inline fieldset_fixed');
                    was_fixed = true;
                }
                else if (was_fixed) {
                    dojo.query('#fieldset_general').attr('class', 'inline form');
                    was_fixed = false;
                }
            });
    });
</script>

<fieldset class="block form">
  <legend>Contact</legend>
  <table>
    <tr>
        <td class="large">{{ form.client.label_tag }}</td><td>{{ form.client }}</td>
        <td class="large right">{{ form.assigned_to.label_tag }}</td><td>{{ form.assigned_to }}</td>
    </tr>
    <tr>
        <td class="large">{{ form.contact.label_tag }}</td><td>{{ form.contact }}</td>
        <td class="large right"><label for="id_opened_by">Ouvert par</label></td><td>{{ form.instance.opened_by }} le {{ form.instance.date_open|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">{{ form.telephone.label_tag }}</td><td>{{ form.telephone }}
            <div dojoType="dijit.form.Button" onClick="loadTelephone();" id="telephoneContainer">Présélection</div>
            <!-- Dojo dialog telephone preselection -->
            <script type="text/javascript">
            function loadTelephone() {
                var client = dijit.byId("id_client");
                var client_id = client.value;

                SimpleAjax('{% url ajax_load_telephone %}', 'client_id='+client_id, function(ajax_response)
                {
                    if (! ajax_response.telephones) { return; }
                    var menu = dijit.byId('telephone_menu');
                    if (menu) {
                        menu.destroyRecursive();
                    } else {
                        menu = new dijit.Menu({id: 'telephone_menu'});
                        
                        var telephone;
                        dojo.forEach(ajax_response.telephones, function(telephone) {
                            var menuItem = new dijit.MenuItem({
                                    label: telephone[2],
                                    onClick: function() {
                                        dojo.byId('id_contact').value = telephone[0];
                                        dojo.byId('id_telephone').value = telephone[1];
                                        menu.destroyRecursive();
                                    }
                                });
                            menu.addChild(menuItem);
                        });
                        dojo.byId("telephoneContainer").appendChild(menu.domNode);
                        menu.focus();
                    }
                });
            }
            </script>
            <!-- / Telephone preselection -->
        </td>
        <td class="large right">Dernière modif.</td><td>le {{ form.instance.last_modification|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">&nbsp;</td><td></td>
        <td class="large right">
            {% if form.instance.validated_by %}
                <strong>Validé par</strong></td><td>{{ form.instance.validated_by }}
            {% else %}
                {% if perms.ticket.can_validate_ticket %}
                    <td colspan="2"><button type="submit" dojoType="dijit.form.Button" name="_validate-ticket" value="Valider ce ticket">Valider ce ticket</button></td>
                {% else %}
                    <strong>Validation:</strong></td><td><strong>En attente</strong>
                {% endif %}
            {% endif %}
        </td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
  <legend>Contenu</legend>
  <table>
    <tr>
        <th class="large">{{ form.title.label_tag }}</th>
        <td class="large right">{{ form.title }}</td>
    </tr>
    <tr>
        <th></th>
        <td class="right">{{ form.text }}</td>
    </tr>
    <tr>
        <th>{{ form.keywords.label_tag }}</th>
        <td class="right">{{ form.keywords }}</td>
    </tr>
  </table>
</fieldset>

{% with form as form_to_comment %}
<fieldset class="block form" style="padding: 0;">
  <legend>Réponses</legend>
{% include "ticket/comment.html" %}
</fieldset>
{% endwith %}

<fieldset class="block form">
  <legend>Planification</legend>
  <table>
    <tr>
        <th class="large">{{ form.calendar_start_time.label_tag }}</th>
        <td class="right">{{ form.calendar_start_time }}</td>
    </tr>
    <tr>
        <th class="large">{{ form.calendar_end_time.label_tag }}</th>
        <td class="right">{{ form.calendar_end_time }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
    <legend>Fichiers joint</legend>
    <table>
        {% for file in form.instance.ticketfile_set.all %}
        <tr>
            <td><a href="{% url ticket_get_file file.pk %}">{{ file.filename }}</a></td>
        </tr>
        {% endfor %}
        <tr>
            <td>{{ form.file }}</td>
        </tr>
    </table>
</fieldset>
<hr />

{% endblock content_ticket %}
</div><!-- parent -->

<script type="text/javascript">
    var last_focused = dojo.byId("parent");
    var fl = null; /* focus list */
    var buttons;

    dojo.addOnLoad(function () {
            fl = dojo.query("div.child");
            fl.style("opacity", "0.5");
            fl.push(dojo.byId("parent"));
            fl.onclick(get_focus);
            if (dojo.doc.location.hash != '') {
                var node = dojo.query(dojo.doc.location.hash);
                if (node.length == 1) {
                    dojo.style(node[0], 'opacity', '1');
                    dojo.style(node[0].id + '_content', 'display', 'inline');
                    dojo.style('parent', 'opacity', '0.5');
                }
            }
            buttons = dojo.query("#save_buttons").query("button");
            });

    function get_focus (ev) {
        fl.style("opacity", "0.5");
        dojo.style(this, "opacity", "1");
        last_focused = this;
    }

{% if perms.ticket.can_add_child %}
    function loadChild () {
        var count = dojo.byId('id_form-TOTAL_FORMS');
        buttons.forEach(function (b) {
                    dijit.byId(b.id).attr('disabled', true);
                });
        dojo.xhrGet({url: '{% url ajax_load_child form.instance.id %}?count='+count.value,
                load: function (data) {
                    var childs;
                    dojo.place(data, 'div_childs', 'last');
                    last_focused = dojo.query('div.child:last-child')[0]
                    fl.style('opacity', '0.5');
                    fl.push(last_focused);
                    dojo.connect(last_focused, 'onclick', get_focus);
                    dojo.parser.parse(last_focused)

                    {% if perms.ticket.add_ticket_full %}
                    /* copie des valeurs du pêre */
                    dojo.attr('id_form-'+count.value+'-assigned_to', 'value', dojo.byId('id_assigned_to').value);
                    dojo.query('input[name="form-'+count.value+'-assigned_to"]')[0].value = dojo.query('input[name="assigned_to"]')[0].value;
                    dojo.forEach(['category', 'project', 'state'], function (e) {
                            if (e == 'state'  && dojo.byId('id_'+e).selectedIndex == {{ settings.TICKET_STATE_CLOSED }}) {
                                dojo.byId('id_'+e).selectedIndex = {{ settings.TICKET_STATE_ACTIVE }};
                                dojo.byId('id_form-'+count.value+'-'+e).selectedIndex = {{ settings.TICKET_STATE_NEW }};
                            }
                            else
                                dojo.byId('id_form-'+count.value+'-'+e).selectedIndex = dojo.byId('id_'+e).selectedIndex;
                        });
                    {% endif %}

                    count.value = parseInt(count.value)+1;
                    buttons.forEach(function (b) {
                            dijit.byId(b.id).attr('disabled', false);
                        });

                    /* aller vers le futur nouveau fils */
                    var node;
                    if ((node = dojo.byId('last_child')))
                        node.removeAttribute('id');
                    dojo.query('div.child:last-child')[0].setAttribute('id', 'last_child');
                    dojo.doc.location.hash = '';
                    dojo.doc.location.hash = 'last_child';
                }});
    }

    function showDeletebox(input) {
        var tid = input.parentNode.getAttribute('ticket_id');
        if (tid) {
            var child = dojo.query('div#child'+tid);
            var title = child.query('input[name$="-title"]')[0];
            var text = child.query('textarea[name$="-text"]')[0];
            if (title.value == '' && text.value == '')
                dojo.style('delete_child'+tid, 'display', 'inline');
            else
                dojo.style('delete_child'+tid, 'display', 'none');
        }
    }
{% endif %}

    function togglePlusMinus(img, content) {
        if (dojo.style(content, "display") == "inline") {
            dojo.style(content, "display", "none");
            img.src = "/media/images/plus.png";
        }
        else {
            dojo.style(content, "display", "inline");
            img.src = "/media/images/minus.png";
        }
    }
    function toggleMailImage(img) {
        var checkbox = dojo.query('input[name$="-diffusion"]', img.parentNode.parentNode)[0];
        if (checkbox.value == 'True') {
            dojo.attr(img, 'src', '/media/images/oxygen/nodiffusion.png');
            dojo.attr(checkbox, 'value', 'False');
        }
        else {
            dojo.attr(img, 'src', '/media/images/oxygen/diffusion.png');
            dojo.attr(checkbox, 'value', 'True');
        }
    }
    function toggleComment(checkbox) {
        var did = dojo.byId(checkbox.id+'-tooltip').children;
        if (checkbox.checked) {
            did[0].style.display = 'none';
            did[1].style.display = 'block';
        }
        else {
            did[0].style.display = 'block';
            did[1].style.display = 'none';
        }
    }
</script>

{% block content_childs %}
<div id="div_childs" class="childs">
{{ child_formset.management_form }}
{% for cf in child_formset.forms %}
{% include "ticket/child.html" %}
{% endfor %}
</div>
{% endblock content_childs %}


<div id="save_buttons">
    {% with form.instance.get_current_alarm as alarm %}
    <div class="left_buttons">
        <div dojoType="dijit.form.Button" id="alarm_button" iconClass="dijitEditorIcon claritick{% if not alarm %}No{% endif %}TicketAlarm" onClick="dijit.byId('alarm_dialog').show();">Alarme</div>
        <div dojoType="dijit.Tooltip" connectId="alarm_button">
            <h3>Alarme</h3>
            <p>En mettant une alarme sur ce ticket, il sera marqué comme urgence.</p>
        </div>
    </div>

    <div dojoType="dijit.Dialog" id="alarm_dialog" title="{{ alarm.title_string|default:"Nouvelle Alarme" }}">
        <label for="id_alarm">Raison </label><br /><textarea rows="12" cols="32" id="id_alarm" name="alarm_reason">{{ alarm.reason }}</textarea>
        <div style="text-align: center;">
            <button dojoType="dijit.form.Button" type="submit" onClick="dojo.byId('id_alarm').value=''; setTicketAlarm();">Annuler l'alarme</button>
            <button dojoType="dijit.form.Button" onClick="setTicketAlarm();">Valider</button>
        </div>
    </div>

    <script type="text/javascript">
        {% if alarm %}
        dojo.addOnLoad(function () {
                dijit.byId('alarm_dialog').show();
        });
        {% endif %}
        function setTicketAlarm() {
            dojo.xhrPost({
            url: '{% url ajax_set_alarm form.instance.id %}',
            postData: dojo.byId('id_alarm').value,
            handleAs: 'text',
            load: function (data) {
                dijit.byId('alarm_dialog').hide();
                var newclass = dojo.byId('id_alarm').value ? "claritickTicketAlarm" : "claritickNoTicketAlarm";
                dijit.byId('alarm_button').attr('iconClass', 'dijitEditorIcon '+newclass);
                dijit.byId('alarm_dialog').attr('title', data);
            }});
        }
    </script>
    {% endwith %}

        <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="save">Enregistrer</button>
          <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="new">Enregistrer et ajouter un nouveau</button>
        <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="return" class="default">Enregistrer et retourner à la liste</button>
        {% if perms.ticket.can_add_child %}
            <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon claritickNewChild" onClick="loadChild();" id="button_add_child">Ajouter un fils</button>
        {% endif %}


    <div class="right_buttons">
    {% if form.instance.ticketmailtrace_set.count %}
    <div dojoType="dijit.form.Button" iconClass="dijitEditorIcon claritickTicketMailAction" id="id_tmt_button" onClick="viewTicketMailTraceDialog();">Trace</div>
    <div dojoType="dijit.Tooltip" connectId="id_tmt_button">
        <h3>Ticket Mail Trace</h3>
        <p>Liste les mails envoyés pour ce ticket</p>
    </div>

    <script type="text/javascript">
        dojo.require('dijit.layout.AccordionContainer');
        var ticketmailtrace = null;
        function viewTicketMailTraceDialog() {
            if (!ticketmailtrace)
            {
                dojo.xhrGet({
                url: '{% url ajax_load_ticketmailtrace form.instance.id %}',
                load: function (data) {
                    ticketmailtrace = data;
                    dojo.parser.parse(ticketmailtrace);
                    showTicketMailTraceDialog();
                },
                });
            }
            else
                showTicketMailTraceDialog();
        }
        function showTicketMailTraceDialog() {
            var dialog = new dijit.Dialog({
                title: 'Ticket Mail Trace',
                content: ticketmailtrace,
                draggable: false,
                });
            dialog.show();
        }
    </script>
    {% endif %}

    {% if perms.ticket.can_delete_tma and form.instance.ticketmailaction_set.count %}
    <div dojoType="dijit.form.DropDownButton" iconClass="dijitEditorIcon claritickTicketMailAction" id="dijit_tmas">
        <span>{{ form.instance.ticketmailaction_set.count }}</span>
        <div dojoType="dijit.Menu">
            <div dojoType="dijit.MenuItem" iconClass="dijitEditorIcon dijitEditorIconDelete" onClick='deleteTmas(dijit.byId("dijit_tmas"), 0);'>Supprimer tout</div>
            {% for tma in form.instance.ticketmailaction_set.all %}
            <div dojoType="dijit.MenuItem" iconClass="dijitEditorIcon dijitEditorIconDelete" onClick='deleteTmas(this, {{ tma.id }})' style="display: block;">{{ tma.reasons|join:"<br />" }}</div>
            {% endfor %}
        </div>
    </div>

    <div dojoType="dijit.Tooltip" connectId="dijit_tmas">
        <h3>Ticket mail action</h3>
        <p>Un mail va bientôt être envoyé en raison des actions récentes qu'il y a eu sur ce ticket</p>
    </div>

    <script type="text/javascript">
    function deleteTmas(button, tma_id) {
        var confirm_string = "Supprimer ";
        confirm_string += (tma_id==0) ? "tous les" : "ce";
        confirm_string += " ticket mail action ?";
        if (confirm(confirm_string)) {
            dojo.xhrGet({
                url: '{% url ajax_delete_tma form.instance.id %}?tma_id='+tma_id,
                });
            count = dojo.byId('dijit_tmas_label');
            count.innerHTML = parseInt(count.innerHTML)-1;
            if (count.innerHTML == 0)
                dijit.byId("dijit_tmas").destroyRecursive();
            else
                button.destroyRecursive();
        }
    }
    </script>
    {% endif %}
    </div><!-- right_buttons -->

</div>

</form>

{% endblock content %}
