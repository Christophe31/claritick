<!-- <?xml version='1.0' encoding='utf-8'?> -->
{% extends "base.html" %}

{% block title %}Ticket numéro {{ form.instance.id }}{% endblock %}
{% block content_title %}Ticket numéro {{ form.instance.id }}{% endblock %}
{% block image %}<img src="/media/images/oxygen/folder-open.png" />{% endblock %}

{% block content %}
{{ form.non_field_errors }}
<form enctype="multipart/form-data" action="{% url ticket_modify form.instance.id %}" method="post">
<div id="parent">
{% csrf_token %}
{% block content_ticket %}
<fieldset class="inline form">
  <legend>Général</legend>
  <div>{{ form.category.label_tag }} {{ form.category }}</div>
  <div>{{ form.project.label_tag }} {{ form.project }}</div>
  <div>{{ form.priority.label_tag }} {{ form.priority }}</div>
  <div>{{ form.state.label_tag }} {{ form.state }}</div>
</fieldset>

<fieldset class="block form">
  <legend>Contact</legend>
  <table>
    <tr>
        <td class="large">{{ form.client.label_tag }}</td><td>{{ form.client }}</td>
        <td class="large right">{{ form.assigned_to.label_tag }}</td><td>{{ form.assigned_to }}</td>
    </tr>
    <tr>
        <td class="large">{{ form.contact.label_tag }}</td><td>{{ form.contact }}</td>
        <td class="large right"><label for="id_opened_by">Ouvert par</label></td><td>{{ form.instance.opened_by }} le {{ form.instance.date_open|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">{{ form.telephone.label_tag }}</td><td>{{ form.telephone }}
            <div dojoType="dijit.form.Button" onClick="loadTelephone();" id="telephoneContainer">Présélection</div>
            <!-- Dojo dialog telephone preselection -->
            <script type="text/javascript">
            function loadTelephone() {
                var client = dijit.byId("id_client");
                var client_id = client.value;

                SimpleAjax('{% url ajax_load_telephone %}', 'client_id='+client_id, function(ajax_response)
                {
                    if (! ajax_response.telephones) { return; }
                    var menu = dijit.byId('telephone_menu');
                    if (menu) {
                        menu.destroyRecursive();
                    } else {
                        menu = new dijit.Menu({id: 'telephone_menu'});
                        
                        var telephone;
                        dojo.forEach(ajax_response.telephones, function(telephone) {
                            var menuItem = new dijit.MenuItem({
                                    label: telephone[1],
                                    onClick: function() {
                                        dojo.byId('id_telephone').value = telephone[0];
                                        menu.destroyRecursive();
                                    }
                                });
                            menu.addChild(menuItem);
                        });
                        dojo.byId("telephoneContainer").appendChild(menu.domNode);
                        menu.focus();
                    }
                });
            }
            </script>
            <!-- / Telephone preselection -->
        </td>
        <td class="large right">Dernière modif.</td><td>le {{ form.instance.last_modification|date:"d/m/Y à H:i" }}</td>
    </tr>
    <tr>
        <td class="large">&nbsp;</td><td></td>
        <td class="large right">
            {% if form.instance.validated_by %}
                <strong>Validé par</strong></td><td>{{ form.instance.validated_by }}
            {% else %}
                {% if perms.ticket.can_validate_ticket %}
                    <td colspan="2"><button type="submit" dojoType="dijit.form.Button" name="_validate-ticket" value="Valider ce ticket">Valider ce ticket</button></td>
                {% else %}
                    <strong>Validation:</strong></td><td><strong>En attente</strong>
                {% endif %}
            {% endif %}
        </td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
  <legend>Contenu</legend>
  <table>
    <tr>
        <th class="large">{{ form.title.label_tag }}</th>
        <td class="large right">{{ form.title }}</td>
    </tr>
    <tr>
        <th></th>
        <td class="right">{{ form.text }}</td>
    </tr>
    <tr>
        <th>{{ form.keywords.label_tag }}</th>
        <td class="right">{{ form.keywords }}</td>
    </tr>
  </table>
</fieldset>

{% with form.instance as ticket_to_comment %}{% with comment_form as form_to_comment %}
<fieldset class="block form" style="padding: 0;">
  <legend>Réponses</legend>
{% include "ticket/comment.html" %}
</fieldset>
{% endwith %}{% endwith %}

<script type="text/javascript">
    function toggleComment(id, did) {
        if (id.checked) {
            dojo.byId(did).children[0].style.display = 'none';
            dojo.byId(did).children[1].style.display = 'block';
        }
        else {
            dojo.byId(did).children[0].style.display = 'block';
            dojo.byId(did).children[1].style.display = 'none';
        }
    }
</script>

<fieldset class="block form">
  <legend>Planification</legend>
  <table>
    <tr>
        <th class="large">{{ form.calendar_start_time.label_tag }}</th>
        <td class="right">{{ form.calendar_start_time }}</td>
    </tr>
    <tr>
        <th class="large">{{ form.calendar_end_time.label_tag }}</th>
        <td class="right">{{ form.calendar_end_time }}</td>
    </tr>
  </table>
</fieldset>

<fieldset class="block form">
    <legend>Fichiers joint</legend>
    <table>
        {% for file in form.instance.ticketfile_set.all %}
        <tr>
            <td><a href="{% url ticket_get_file file.pk %}">{{ file.filename }}</a></td>
        </tr>
        {% endfor %}
        <tr>
            <td>{{ form.file }}</td>
        </tr>
    </table>
</fieldset>
<hr />

{% endblock content_ticket %}
</div><!-- parent -->

<script type="text/javascript">
    var last_focused = dojo.byId("parent");
    var fl = null; /* focus list */
    var buttons;

    dojo.addOnLoad(function () {
            fl = dojo.query("div.child");
            fl.style("opacity", "0.5");
            fl.push(dojo.byId("parent"));
            fl.onclick(get_focus);
            if (dojo.doc.location.hash != '') {
                var node = dojo.query(dojo.doc.location.hash);
                if (node.length == 1) {
                    dojo.style(node[0], 'opacity', '1');
                    dojo.style(node[0].id + '_content', 'display', 'inline');
                    dojo.style('parent', 'opacity', '0.5');
                }
            }
            buttons = dojo.query("#save_buttons").query("button");
            });

    function get_focus (ev) {
        fl.style("opacity", "0.5");
        dojo.style(this, "opacity", "1");
        last_focused = this;
    }

{% if perms.ticket.can_add_child %}
    function loadChild () {
        var count = dojo.byId('id_form-TOTAL_FORMS');
        buttons.forEach(function (b) {
                    dijit.byId(b.id).attr('disabled', true);
                });
        dojo.xhrGet({url: '{% url ajax_load_child form.instance.id %}?count='+count.value,
                load: function (data) {
                    var childs;
                    dojo.place(data, 'div_childs', 'last');
                    last_focused = dojo.query('div.child:last-child')[0]
                    fl.style('opacity', '0.5');
                    fl.push(last_focused);
                    dojo.connect(last_focused, 'onclick', get_focus);
                    dojo.parser.parse(last_focused)

                    /* copie des valeurs du pêre */
                    dojo.attr('id_form-'+count.value+'-assigned_to', 'value', dojo.byId('id_assigned_to').value);
                    dojo.query('input[name="form-'+count.value+'-assigned_to"]')[0].value = dojo.query('input[name="assigned_to"]')[0].value;
                    dojo.forEach(['category', 'project', 'state'], function (e) {
                            dojo.byId('id_form-'+count.value+'-'+e).selectedIndex = dojo.byId('id_'+e).selectedIndex;
                        });

                    count.value = parseInt(count.value)+1;
                    buttons.forEach(function (b) {
                            dijit.byId(b.id).attr('disabled', false);
                        });

                    /* aller vers le futur nouveau fils */
                    var node;
                    if ((node = dojo.byId('last_child')))
                        node.removeAttribute('id');
                    dojo.query('div.child:last-child')[0].setAttribute('id', 'last_child');
                    dojo.doc.location.hash = '';
                    dojo.doc.location.hash = 'last_child';
                }});
    }

    function showDeletebox(input) {
        var tid = input.parentNode.getAttribute('ticket_id');
        if (tid) {
            var child = dojo.query('div#child'+tid);
            var title = child.query('input[name$="-title"]')[0];
            var text = child.query('textarea[name$="-text"]')[0];
            if (title.value == '' && text.value == '')
                dojo.style('delete_child'+tid, 'display', 'inline');
            else
                dojo.style('delete_child'+tid, 'display', 'none');
        }
    }
{% endif %}

    function togglePlusMinus(img, content) {
        if (dojo.style(content, "display") == "inline") {
            dojo.style(content, "display", "none");
            img.src = "/media/images/plus.png";
        }
        else {
            dojo.style(content, "display", "inline");
            img.src = "/media/images/minus.png";
        }
    }
    function toggleMailImage(img) {
        var checkbox = dojo.query('input[name$="-diffusion"]', img.parentNode.parentNode)[0];
        if (checkbox.checked) {
            dojo.attr(img, 'src', '/media/images/oxygen/nodiffusion.png');
            checkbox.removeAttribute('checked');
        }
        else {
            dojo.attr(img, 'src', '/media/images/oxygen/diffusion.png');
            dojo.attr(checkbox, 'checked', 'checked');
        }
    }
</script>

<div id="div_childs" class="childs">
{{ child_formset.management_form }}
{% for cf,cfc in child_form %}
{% include "ticket/child.html" %}
{% endfor %}
</div>

<div id="save_buttons">
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="save">Enregistrer</button>
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="new">Enregistrer et ajouter un nouveau</button>
  <button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconSave" type="submit" name="savebutton" value="return" class="default">Enregistrer et retourner à la liste</button>
{% if perms.ticket.can_add_child %}<button dojoType="dijit.form.Button" iconClass="dijitEditorIcon dijitEditorIconNewPage claritickNewChild" onClick="loadChild();" id="button_add_child">Ajouter un fils</button>{% endif %}
</div>

</form>

{% endblock content %}
